# GitHub Actions å·¥ä½œæµï¼šéƒ¨ç½²åˆ°åä¸ºäº‘
name: Deploy to Huawei Cloud

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [main]                       # æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  workflow_dispatch:                       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  REGISTRY: swr.tr-istanbul.myhuaweicloud.com  # åä¸ºäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼ˆSWRï¼‰åœ°å€
  IMAGE_NAME: pipeline-manager             # Docker é•œåƒåç§°
  IMAGE_TAG: latest                        # é•œåƒæ ‡ç­¾

# ä»»åŠ¡å®šä¹‰
jobs:
  # ä»»åŠ¡ 1ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  build-and-push:
    runs-on: ubuntu-latest                 # åœ¨ Ubuntu æœ€æ–°ç‰ˆè¿è¡Œå™¨ä¸Šæ‰§è¡Œ
    permissions:
      contents: read                       # ä»…éœ€è¯»å–ä»“åº“å†…å®¹çš„æƒé™
      
    steps:
      - name: Checkout repository          # æ­¥éª¤ 1ï¼šæ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: Set up Docker Buildx         # æ­¥éª¤ 2ï¼šè®¾ç½® Docker Buildx å¤šå¹³å°æ„å»ºå·¥å…·
        uses: docker/setup-buildx-action@v2

      - name: Log in to Huawei SWR         # æ­¥éª¤ 3ï¼šç™»å½•åä¸ºäº‘ SWR é•œåƒä»“åº“
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}    # SWR æ³¨å†Œä¸­å¿ƒåœ°å€
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}  # åä¸ºäº‘ç”¨æˆ·åï¼ˆGitHub Secretsï¼‰
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}  # åä¸ºäº‘å¯†ç ï¼ˆGitHub Secretsï¼‰

      - name: Build and push Docker image  # æ­¥éª¤ 4ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v4
        with:
          context: .                       # æ„å»ºä¸Šä¸‹æ–‡ä¸ºå½“å‰ç›®å½•
          push: true                       # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          tags: |                          # é•œåƒæ ‡ç­¾ï¼ˆåŒæ—¶æ‰“ latest å’Œ commit hash ä¸¤ä¸ªæ ‡ç­¾ï¼‰
            ${{ env.REGISTRY }}/${{ secrets.HUAWEI_CLOUD_ORGANIZATION }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ secrets.HUAWEI_CLOUD_ORGANIZATION }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha             # ä½¿ç”¨ GitHub Actions ç¼“å­˜åŠ é€Ÿæ„å»º
          cache-to: type=gha,mode=max      # æœ€å¤§åŒ–ç¼“å­˜

  # ä»»åŠ¡ 2ï¼šéƒ¨ç½²åˆ°åä¸ºäº‘ ECS
  deploy:
    needs: build-and-push                  # ä¾èµ–ä»»åŠ¡ 1 å®Œæˆåæ‰æ‰§è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository          # æ­¥éª¤ 1ï¼šæ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: Deploy to Huawei ECS         # æ­¥éª¤ 2ï¼šéƒ¨ç½²åˆ°åä¸ºäº‘å¼¹æ€§äº‘æœåŠ¡å™¨
        env:
          HUAWEI_AK: ${{ secrets.HUAWEI_CLOUD_AK }}              # åä¸ºäº‘ Access Key
          HUAWEI_SK: ${{ secrets.HUAWEI_CLOUD_SK }}              # åä¸ºäº‘ Secret Key
          HUAWEI_PROJECT_ID: ${{ secrets.HUAWEI_CLOUD_PROJECT_ID }} # é¡¹ç›® ID
          ECS_INSTANCE_ID: ${{ secrets.HUAWEI_ECS_INSTANCE_ID }}    # ECS å®ä¾‹ ID
          IMAGE_URL: ${{ env.REGISTRY }}/${{ secrets.HUAWEI_CLOUD_ORGANIZATION }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          # å®Œæ•´çš„é•œåƒ URL
        run: |
          echo "ğŸ“¦ Docker image pushed to Huawei SWR:"
          echo "   $IMAGE_URL"
          # è¾“å‡ºé•œåƒå·²æ¨é€åˆ° SWR çš„ä¿¡æ¯
          echo ""
          echo "âœ… Next steps:"
          echo "   1. Log in to Huawei Cloud Console"
          # ä¸‹ä¸€æ­¥ 1ï¼šç™»å½•åä¸ºäº‘æ§åˆ¶å°
          echo "   2. Navigate to ECS â†’ Instances"
          # ä¸‹ä¸€æ­¥ 2ï¼šè¿›å…¥ ECS å®ä¾‹åˆ—è¡¨
          echo "   3. SSH into your instance"
          # ä¸‹ä¸€æ­¥ 3ï¼šSSH è¿æ¥åˆ°å®ä¾‹
          echo "   4. Pull and run the latest image:"
          # ä¸‹ä¸€æ­¥ 4ï¼šæ‹‰å–å¹¶è¿è¡Œæœ€æ–°é•œåƒ
          echo "      docker pull $IMAGE_URL"
          echo "      docker run -d -p 5000:5000 \\"
          echo "        -e NODE_ENV=production \\"
          echo "        -e JWT_SECRET=your_secret \\"
          echo "        --name pipeline-manager \\"
          echo "        $IMAGE_URL"
